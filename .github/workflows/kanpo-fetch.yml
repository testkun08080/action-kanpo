name: 毎日官報発行チェッカー

on:
  schedule:
    - cron: "45 23 * * *" # 毎日8:45 JST
  workflow_dispatch:

jobs:
  fetch-kanpo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: 官報チェック(DL無し)
        id: fetch-kanpo-step
        uses: testkun08080/action-kanpo@main
        with:
          dlpdf: "false" # PDFをダウンロードしない
          date: "2025-07-03"
      - name: 官報チェック結果を出力
        id: output-fettch-kanpo-step
        run: |
          echo "kanpou_found=${{ steps.fetch-kanpo-step.outputs.kanpou_found }}"
          echo "pdf_infos=${{ steps.fetch-kanpo-step.outputs.pdf_infos }}"

    outputs:
      kanpou_found: ${{ steps.fetch-kanpo-step.outputs.kanpou_found }}
      pdf_infos: ${{ steps.fetch-kanpo-step.outputs.pdf_infos }}

  show-results:
    needs: fetch-kanpo
    runs-on: ubuntu-latest
    steps:
      - name: 結果を表示
        run: |
          echo "官報取得成功 or 失敗: ${{needs.fetch-kanpo.outputs.kanpou_found}}"
          echo "取得PDF数: ${{needs.fetch-kanpo.outputs.pdf_infos}}"

  fetch-dl-kanpo:
    needs: fetch-kanpo
    if: needs.fetch-kanpo.outputs.kanpou_found == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ダウンロード後の待機
        run: |
          echo "⌛ 5秒待機中..."
          sleep 5

      - name: 官報チェック(DLあり)
        id: fetch-dl-kanpo-step
        uses: testkun08080/action-kanpo@main
        with:
          dlpdf: "true" # PDFをダウンロードする
          date: "2025-07-03"
      - name: 官報チェック結果を出力
        id: output-fetch-dl-kanpo-step
        run: |
          echo "kanpou_found=${{ steps.fetch-dl-kanpo-step.outputs.kanpou_found }}"
          echo "pdf_infos=${{ steps.fetch-dl-kanpo-step.outputs.pdf_infos }}"

  commit:
    name: 変更をコミット
    runs-on: ubuntu-latest
    needs: fetch-dl-kanpo
    if: success()
    steps:
      - uses: actions/checkout@v4

      - name: kanpo ディレクトリ構造（ツリー形式）表示
        run: |
          apt-get update && apt-get install -y tree
          if [ -d kanpo ]; then
            tree -a kanpo
          else
            echo "⚠️ kanpo ディレクトリが見つかりません"
          fi

      - name: Git 設定とコミット
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          if git diff --staged --quiet; then
            echo "📭 変更なし（新しい官報はありません）"
          else
            git commit -m "官報更新: $(date '+%Y-%m-%d')"
            git push

  # tweet:
  #   name: ツイート送信
  #   needs: test
  #   if: success()
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: noweh/post-tweet-v2-action@v1.0
  #       with:
  #         message: "今日の官報！最新の官報をチェックしてください。 #官報"
  #         consumer-key: ${{ secrets.TWITTER_CONSUMER_KEY }}
  #         consumer-secret: ${{ secrets.TWITTER_CONSUMER_SECRET }}
  #         access-token: ${{ secrets.TWITTER_ACCESS_TOKEN }}
  #         access-token-secret: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
